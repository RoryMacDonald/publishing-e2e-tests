#!/usr/bin/env ruby

class App
  def initialize(name)
    @name = name
  end

  def prepare
    Dir.chdir("apps") do
      File.directory?(name) ? update : clone
    end
  end

private

  attr_reader :name

  def clone
    unless system "git clone #{git_url}"
      raise "git clone failed for #{git_url}"
    end
  end

  def has_local_changes?
    !system("git diff --quiet --ignore-submodules --no-ext-diff")
  end

  def checkout
    unless system "git checkout #{commitish}"
      raise "git failed to checkout #{commitish}"
    end
  end

  def fetch_origin
    unless system "git fetch origin"
      raise "git fetch failed for #{name}"
    end
  end

  def reset
    unless system "git reset --hard HEAD"
      raise "reset failed for #{name}"
    end
  end

  def update
    Dir.chdir(name) do
      if has_local_changes?
        puts "skipped updating #{name} due to local changes"
      else
        fetch_origin
        checkout
        reset
      end
    end
  end

  def git_url
    "https://github.com/alphagov/#{name}.git"
  end

  def upper_name
    name.gsub(/\-/, "_").upcase
  end

  def commitish
    ENV.fetch("#{upper_name}_COMMITISH", "master")
  end
end

ARGV.each do |name|
  App.new(name).prepare
end
